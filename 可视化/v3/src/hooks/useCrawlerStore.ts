import { useState, useEffect, useRef, useCallback } from "react";
import { CrawlerStore, DownloadedFile } from "@/types/crawler";
import { Cookie } from "@/types/cookie";
import {
  startCrawlTask,
  getCrawlStatus,
  setApiConfig,
  downloadCommentData,
  getApiConfig,
} from "@/utils/api";
import { dataStorage } from "@/utils/dataStorage";

export const useCrawlerStore = (): CrawlerStore => {
  // Áä∂ÊÄÅÂÆö‰πâ
  const [cookies, setCookies] = useState<Cookie[]>([]);
  const [cookiesLoading, setCookiesLoading] = useState(false);
  const [baseUrl, setBaseUrl] = useState<string>("http://localhost:8000");
  const [showApiConfig, setShowApiConfig] = useState(false);
  const [bv, setBv] = useState("");
  const [currentTaskId, setCurrentTaskId] = useState<string>("");
  const [crawlStatus, setCrawlStatus] = useState<string>("");
  const [progress, setProgress] = useState<number | null>(null);
  const [isDownloading, setIsDownloading] = useState(false);
  const [showDownloadButton, setShowDownloadButton] = useState(false);
  const [downloadedFiles, setDownloadedFiles] = useState<DownloadedFile[]>([]);
  const [isLoading] = useState(false);
  const [currentUrl] = useState("");

  const pollingRef = useRef<NodeJS.Timeout | null>(null);
  const pollStartTimeRef = useRef<number>(0); // ËΩÆËØ¢ÂºÄÂßãÊó∂Èó¥

  // Ê£ÄÊü•ÊòØÂê¶Âú®ÊµèËßàÂô®ÁéØÂ¢É‰∏≠
  const isBrowser = typeof window !== "undefined";

  // ËæÖÂä©ÂáΩÊï∞
  const saveDownloadedFiles = useCallback(async (files: DownloadedFile[]) => {
    try {
      // ‰øùÂ≠òÊñá‰ª∂ÂÖÉ‰ø°ÊÅØÂà∞ localStorage
      const filesForStorage = files.map(file => ({
        ...file,
        data: undefined, // ‰∏ç‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage
        hasCache: !!file.data // Ê†áËÆ∞ÊòØÂê¶ÊúâÁºìÂ≠òÊï∞ÊçÆ
      }));
      localStorage.setItem("downloaded_files", JSON.stringify(filesForStorage));
      
      // ‰øùÂ≠òÁºìÂ≠òÊï∞ÊçÆÂà∞ IndexedDB
      for (const file of files) {
        if (file.data) {
          await dataStorage.saveData(file.id, file.data);
        }
      }
    } catch (error) {
      console.error("‰øùÂ≠òÂ∑≤‰∏ãËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:", error);
    }
  }, []);

  const loadDownloadedFiles = useCallback(async () => {
    try {
      const savedFiles = localStorage.getItem("downloaded_files");
      if (savedFiles) {
        const parsedFiles = JSON.parse(savedFiles);
        
        // ÊÅ¢Â§çÁºìÂ≠òÊï∞ÊçÆ
        const filesWithCache = await Promise.all(
          parsedFiles.map(async (file: DownloadedFile & { hasCache?: boolean }) => {
            if (file.hasCache) {
              try {
                const cachedData = await dataStorage.getData(file.id);
                return { ...file, data: cachedData };
              } catch (error) {
                console.warn(`Âä†ËΩΩÊñá‰ª∂ ${file.id} ÁöÑÁºìÂ≠òÊï∞ÊçÆÂ§±Ë¥•:`, error);
                return file;
              }
            }
            return file;
          })
        );
        
        setDownloadedFiles(filesWithCache);
        console.log(`üîÑ Êñá‰ª∂Âä†ËΩΩÂÆåÊàê: ÊÄªÂÖ± ${filesWithCache.length} ‰∏™Êñá‰ª∂`);
        console.log(`üì¶ ÂÖ∂‰∏≠ÊúâÁºìÂ≠òÊï∞ÊçÆÁöÑÊñá‰ª∂: ${filesWithCache.filter(f => f.data).length} ‰∏™`);
        console.log('üìã Êñá‰ª∂ËØ¶ÊÉÖ:', filesWithCache.map(f => ({ 
          name: f.name, 
          hasData: !!f.data, 
          dataSize: f.data ? f.data.length : 0 
        })));
      }
    } catch (error) {
      console.error("ËØªÂèñÂ∑≤‰∏ãËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:", error);
    }
  }, []);

  const loadCookiesFromStorage = useCallback(() => {
    try {
      const savedCookies = localStorage.getItem("bilibili_cookies");
      if (savedCookies) {
        const parsedCookies = JSON.parse(savedCookies);
        setCookies(parsedCookies);
      }
    } catch (error) {
      console.error("ËØªÂèñÊú¨Âú∞Â≠òÂÇ®Êó∂ÂèëÁîüÈîôËØØ:", error);
    }
  }, []);

  // ËΩÆËØ¢‰ªªÂä°ËøõÂ∫¶
  const startPolling = useCallback((task_id: string) => {
    if (pollingRef.current) clearInterval(pollingRef.current);
    
    // ËÆ∞ÂΩïËΩÆËØ¢ÂºÄÂßãÊó∂Èó¥
    pollStartTimeRef.current = Date.now();
    const config = getApiConfig();
    
    console.log(`üîÑ ÂºÄÂßãËΩÆËØ¢‰ªªÂä° ${task_id}ÔºåÈó¥Èöî: ${config.pollInterval}msÔºåË∂ÖÊó∂: ${config.pollTimeout}ms`);
    
    pollingRef.current = setInterval(async () => {
      try {
        // Ê£ÄÊü•ËΩÆËØ¢ÊòØÂê¶Ë∂ÖÊó∂
        const elapsedTime = Date.now() - pollStartTimeRef.current;
        if (elapsedTime > config.pollTimeout) {
          console.warn(`‚è∞ ËΩÆËØ¢Ë∂ÖÊó∂ (${elapsedTime}ms)ÔºåÂÅúÊ≠¢ËΩÆËØ¢`);
          clearInterval(pollingRef.current!);
          setCrawlStatus(`ËΩÆËØ¢Ë∂ÖÊó∂ (${Math.round(elapsedTime / 1000)}Áßí)Ôºå‰ªªÂä°ÂèØËÉΩ‰ªçÂú®ÂêéÂè∞ËøêË°å„ÄÇËØ∑Á®çÂêéÊâãÂä®Âà∑Êñ∞È°µÈù¢Êü•ÁúãÁä∂ÊÄÅ„ÄÇ`);
          return;
        }
        
        const data = await getCrawlStatus(task_id);

        if (data.error) {
          console.error("ËΩÆËØ¢Ëé∑ÂèñÁä∂ÊÄÅÊó∂Âá∫Èîô:", data.error);
          setCrawlStatus(`Áä∂ÊÄÅÊü•ËØ¢Â§±Ë¥•: ${data.error}`);
          // ÂØπ‰∫éÁΩëÁªúÈîôËØØÔºåÁªßÁª≠ËΩÆËØ¢ËÄå‰∏çÂÅúÊ≠¢
          if (!data.error.includes("ÁΩëÁªú") && !data.error.includes("Ë∂ÖÊó∂")) {
            clearInterval(pollingRef.current!);
            return;
          }
        }

        const status = data.status || "UNKNOWN";
        const progressText = data.progress || "";

        if (progressText) {
          setCrawlStatus(progressText);
        }

        if (typeof data.progress === "number") {
          setProgress(data.progress);
        }

        const terminalStates = ["SUCCESS", "FAILURE", "REVOKED", "ERROR"];

        if (terminalStates.includes(status)) {
          clearInterval(pollingRef.current!);
          console.log(`‚úÖ ËΩÆËØ¢ÁªìÊùüÔºåÊúÄÁªàÁä∂ÊÄÅ: ${status}`);

          if (status === "SUCCESS") {
            setShowDownloadButton(true);
            setCrawlStatus("Áà¨ÂèñÂÆåÊàêÔºÅÁÇπÂáª‰∏ãËΩΩÊåâÈíÆËé∑ÂèñËØÑËÆ∫Êï∞ÊçÆ");
          } else if (status === "FAILURE") {
            setCrawlStatus(`‰ªªÂä°Â§±Ë¥•: ${data.error || "Êú™Áü•ÈîôËØØ"}`);
          } else {
            setCrawlStatus(`‰ªªÂä°Áä∂ÊÄÅ: ${status}`);
          }
        } else {
          // ÊòæÁ§∫Â∑≤ÁªèËΩÆËØ¢ÁöÑÊó∂Èó¥
          const minutes = Math.floor(elapsedTime / 60000);
          const seconds = Math.floor((elapsedTime % 60000) / 1000);
          const timeStr = minutes > 0 ? `${minutes}ÂàÜ${seconds}Áßí` : `${seconds}Áßí`;
          console.log(`üîç ËΩÆËØ¢‰∏≠... Áä∂ÊÄÅ: ${status}, Â∑≤ËøêË°å: ${timeStr}`);
        }
      } catch (error) {
        console.error("ËΩÆËØ¢Â§±Ë¥•:", error);
        const elapsedTime = Date.now() - pollStartTimeRef.current;
        const minutes = Math.floor(elapsedTime / 60000);
        const seconds = Math.floor((elapsedTime % 60000) / 1000);
        const timeStr = minutes > 0 ? `${minutes}ÂàÜ${seconds}Áßí` : `${seconds}Áßí`;
        setCrawlStatus(`Áä∂ÊÄÅÊü•ËØ¢Â§±Ë¥•: ÁΩëÁªúÈîôËØØ (Â∑≤ËøêË°å: ${timeStr})`);
      }
    }, config.pollInterval);
  }, []);

  // ÂàùÂßãÂåñ
  useEffect(() => {
    if (isBrowser) {
      // ÂàùÂßãÂåñÊï∞ÊçÆÂ≠òÂÇ®
      const initStorage = async () => {
        try {
          await dataStorage.init();
          // Ê∏ÖÁêÜËøáÊúüÊï∞ÊçÆ
          await dataStorage.cleanExpiredData();
          console.log("Êï∞ÊçÆÂ≠òÂÇ®ÂàùÂßãÂåñÂÆåÊàê");
        } catch (error) {
          console.error("Êï∞ÊçÆÂ≠òÂÇ®ÂàùÂßãÂåñÂ§±Ë¥•:", error);
        }
      };
      
      initStorage();
      loadCookiesFromStorage();
      loadDownloadedFiles();
    }
  }, [isBrowser, loadCookiesFromStorage, loadDownloadedFiles]);

  // Ê∏ÖÁêÜ
  useEffect(() => {
    return () => {
      if (pollingRef.current) {
        clearInterval(pollingRef.current);
      }
    };
  }, []);

  // Êìç‰ΩúÂáΩÊï∞
  const getCookiesFromExtension = useCallback(
    (
      onSuccess?: (count: number) => void,
      onError?: (error: string) => void
    ) => {
      if (!isBrowser) return;

      setCookiesLoading(true);

      // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
      const timeoutId = setTimeout(() => {
        setCookiesLoading(false);
        onError?.("Ëé∑ÂèñCookieË∂ÖÊó∂ÔºåËØ∑Á°Æ‰øùÊâ©Â±ïÂ∑≤ÂÆâË£ÖÂπ∂ÂêØÁî®");
      }, 10000); // 10ÁßíË∂ÖÊó∂

      // ÁõëÂê¨‰∏ÄÊ¨°ÊÄßÊ∂àÊÅØ
      const handleMessage = (event: MessageEvent) => {
        if (event.origin !== window.location.origin) return;
        if (event.source !== window) return;

        console.log("Êî∂Âà∞Ê∂àÊÅØ:", event.data);

        if (event.data.type === "BILIBILI_COOKIES_RESULT") {
          clearTimeout(timeoutId);

          window.removeEventListener("message", handleMessage);
          setCookiesLoading(false);

          if (event.data) {
            console.log("Ëé∑ÂèñÂà∞Cookie:", event.data.cookies);
            setCookies(event.data.cookies);
            localStorage.setItem(
              "bilibili_cookies",
              JSON.stringify(event.data.cookies)
            );
            onSuccess?.(event.data.cookies.length);
          } else {
            console.error("Ëé∑ÂèñCookieÂ§±Ë¥•:", event.data.error);
            onError?.(event.data.error || "Êú™Áü•ÈîôËØØ");
          }
        }
      };

      window.addEventListener("message", handleMessage);
      window.postMessage({ type: "GET_BILIBILI_COOKIES" }, "*");
    },
    [isBrowser]
  );

  const clearCookies = useCallback(() => {
    console.log("Ê∏ÖÈô§ÊâÄÊúâCookie");
    
    setCookies([]);
    if (isBrowser) {
      localStorage.removeItem("bilibili_cookies");
    }
  }, [isBrowser]);

  const clearExpiredCookies = useCallback(() => {
    console.log("Ê∏ÖÈô§ËøáÊúüCookie");
    const now = Date.now();
    const validCookies = cookies.filter((cookie) => {
      return !cookie.expirationDate || cookie.expirationDate * 1000 > now;
    });

    if (validCookies.length < cookies.length) {
        console.log(`Ê∏ÖÈô§ËøáÊúüCookie: ${cookies.length - validCookies.length} ‰∏™`);
      setCookies(validCookies);
      if (isBrowser) {
        localStorage.setItem("bilibili_cookies", JSON.stringify(validCookies));
      }
    }
  }, [cookies, isBrowser]);

  const saveApiConfig = useCallback(async () => {
    try {
      if (!baseUrl.trim()) {
        return;
      }

      await setApiConfig({ baseURL: baseUrl.trim() });
    } catch (error) {
      console.error("ËÆæÁΩÆAPIÈÖçÁΩÆÂ§±Ë¥•:", error);
    }
  }, [baseUrl]);

  const resetApiConfig = useCallback(() => {
    const defaultUrl = "http://localhost:8000";
    setBaseUrl(defaultUrl);
  }, []);

  const toggleApiConfig = useCallback(() => {
    setShowApiConfig(!showApiConfig);
  }, [showApiConfig]);

  const startCrawl = useCallback(async () => {
    if (!bv.trim()) {
      setCrawlStatus("ËØ∑ËæìÂÖ•BVÂè∑");
      return;
    }

    if (cookies.length === 0) {
      setCrawlStatus("ËØ∑ÂÖàËé∑ÂèñCookie");
      return;
    }

    setCrawlStatus("Êèê‰∫§Áà¨Âèñ‰ªªÂä°‰∏≠...");
    setShowDownloadButton(false);
    setProgress(null);

    const bvId = bv.trim();
    setCurrentTaskId("");

    try {
      const data = await startCrawlTask(bvId, cookies);
      if (data && data.task_id) {
        setCrawlStatus("‰ªªÂä°Â∑≤Êèê‰∫§ÔºåÊ≠£Âú®Áà¨Âèñ...");
        setCurrentTaskId(data.task_id);
        startPolling(data.task_id);
      } else {
        setCrawlStatus("‰ªªÂä°Êèê‰∫§Â§±Ë¥•: " + (data.error || "Êú™Áü•ÈîôËØØ"));
      }
    } catch (err) {
      console.error("Áà¨Âèñ‰ªªÂä°ÈîôËØØ:", err);
      setCrawlStatus("ËØ∑Ê±ÇÂ§±Ë¥•: ÂêéÁ´ØAPIÂ∞öÊú™ÂÆûÁé∞ÔºåËØ∑ÂÖàÂºÄÂèëÂêéÁ´ØÊé•Âè£");
    }
  }, [bv, cookies, startPolling]);

  const downloadFile = useCallback(
    async (taskId: string) => {
      setIsDownloading(true);
      setCrawlStatus("Ê≠£Âú®‰∏ãËΩΩÊñá‰ª∂ÔºåËØ∑Á®çÂÄô...");

      try {
        const result = await downloadCommentData(taskId);
        if (result.error) {
          console.error("‰∏ãËΩΩÂ§±Ë¥•:", result.error);
          setCrawlStatus(`‰∏ãËΩΩÂ§±Ë¥•: ${result.error}`);
        } else {
          // Ëß¶ÂèëÊñá‰ª∂‰∏ãËΩΩ
          if (result.blob) {
            const downloadUrl = window.URL.createObjectURL(result.blob);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = result.filename || `${bv}_comments.json`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(downloadUrl);
          }
          
          // Ê∑ªÂä†Âà∞Â∑≤‰∏ãËΩΩÊñá‰ª∂ÂàóË°®ÔºàÂåÖÂê´ÁºìÂ≠òÁöÑÊï∞ÊçÆÔºâ
          const newFile: DownloadedFile = {
            id: Date.now().toString(),
            name: result.filename || `${bv}_comments.json`,
            taskId: taskId,
            createdAt: new Date(),
            size: result.fileSize,
            data: result.data, // ÁºìÂ≠òËß£ÊûêÂêéÁöÑJSONÊï∞ÊçÆ
          };
          const updatedFiles = [newFile, ...downloadedFiles];
          setDownloadedFiles(updatedFiles);
          await saveDownloadedFiles(updatedFiles);
          
          setCrawlStatus("Êñá‰ª∂‰∏ãËΩΩÂÆåÊàêÔºÅ");
        }
      } catch (error) {
        console.error("‰∏ãËΩΩÈîôËØØ:", error);
        setCrawlStatus(`‰∏ãËΩΩÂá∫Èîô: ${error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"}`);
      } finally {
        setIsDownloading(false);
      }
    },
    [bv, downloadedFiles, saveDownloadedFiles]
  );

  // Êñá‰ª∂Êìç‰Ωú
  const deleteFile = useCallback(
    async (fileId: string) => {
      // Âà†Èô§ IndexedDB ‰∏≠ÁöÑÁºìÂ≠òÊï∞ÊçÆ
      try {
        await dataStorage.deleteData(fileId);
      } catch (error) {
        console.warn("Âà†Èô§ÁºìÂ≠òÊï∞ÊçÆÂ§±Ë¥•:", error);
      }
      
      const updatedFiles = downloadedFiles.filter((file) => file.id !== fileId);
      setDownloadedFiles(updatedFiles);
      await saveDownloadedFiles(updatedFiles);
    },
    [downloadedFiles, saveDownloadedFiles]
  );

  const visualizeFile = useCallback(
    (fileId: string) => {
      const file = downloadedFiles.find((f) => f.id === fileId);
      if (file) {
        if (isBrowser) {
          // Â¶ÇÊûúÊúâÁºìÂ≠òÁöÑÊï∞ÊçÆÔºåÁõ¥Êé•‰º†ÈÄíÁªôÂèØËßÜÂåñÈ°µÈù¢
          if (file.data) {
            // Â∞ÜÊï∞ÊçÆÂ≠òÂÇ®Âú®sessionStorage‰∏≠Ôºå‰æõÂèØËßÜÂåñÈ°µÈù¢‰ΩøÁî®
            sessionStorage.setItem('visualizationData', JSON.stringify({
              filename: file.name,
              data: file.data
            }));
            window.location.href = `/visualization?cached=true`;
          } else {
            // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊèêÁ§∫Áî®Êà∑ÈáçÊñ∞‰∏ãËΩΩ
            if (confirm('ËØ•Êñá‰ª∂ÁöÑÊï∞ÊçÆÊú™ÁºìÂ≠òÔºåÈúÄË¶ÅÈáçÊñ∞‰∏ãËΩΩÊï∞ÊçÆÊâçËÉΩËøõË°åÂèØËßÜÂåñ„ÄÇÊòØÂê¶Á´ãÂç≥ÈáçÊñ∞‰∏ãËΩΩÔºü')) {
              // ÈáçÊñ∞‰∏ãËΩΩÊñá‰ª∂
              downloadFile(file.taskId);
            }
          }
        }
      }
    },
    [downloadedFiles, isBrowser, downloadFile]
  );

  // ÈÄöÁî®Êìç‰Ωú
  const stopPolling = useCallback(() => {
    if (pollingRef.current) {
      clearInterval(pollingRef.current);
      pollingRef.current = null;
      setCrawlStatus("Â∑≤ÂÅúÊ≠¢Áä∂ÊÄÅËΩÆËØ¢");
    }
  }, []);

  const setMessage = useCallback((message: string) => {
    // Ëøô‰∏™ÂáΩÊï∞‰øùÁïô‰ΩÜ‰∏çÂÅö‰ªª‰ΩïÊìç‰ΩúÔºå‰øùÊåÅÊé•Âè£ÂÖºÂÆπÊÄß
    console.log("Ê∂àÊÅØ:", message);
  }, []);

  const clearMessage = useCallback(() => {
    // Ëøô‰∏™ÂáΩÊï∞‰øùÁïô‰ΩÜ‰∏çÂÅö‰ªª‰ΩïÊìç‰ΩúÔºå‰øùÊåÅÊé•Âè£ÂÖºÂÆπÊÄß
  }, []);

  return {
    // Áä∂ÊÄÅ
    cookies,
    cookiesLoading,
    baseUrl,
    showApiConfig,
    bv,
    currentTaskId,
    crawlStatus,
    progress,
    isDownloading,
    showDownloadButton,
    downloadedFiles,
    isLoading,
    currentUrl,

    // Êìç‰Ωú
    getCookiesFromExtension,
    loadCookiesFromStorage,
    clearCookies,
    clearExpiredCookies,
    saveApiConfig,
    resetApiConfig,
    toggleApiConfig,
    setBaseUrl,
    setBv,
    startCrawl,
    downloadFile,
    deleteFile,
    visualizeFile,
    stopPolling,
    setMessage,
    clearMessage,
  };
};
