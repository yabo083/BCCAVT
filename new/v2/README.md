# FastAPI + Celery Bç«™è¯„è®ºçˆ¬è™«åç«¯ v2.0

è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI å’Œ Celery çš„ Bç«™è¯„è®ºçˆ¬è™«åç«¯æœåŠ¡ï¼Œæ”¯æŒå¼‚æ­¥ä»»åŠ¡å¤„ç†å’Œå®æ—¶çŠ¶æ€æŸ¥è¯¢ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

- **å¼‚æ­¥å¤„ç†**: åŸºäº Celery çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒé«˜å¹¶å‘çˆ¬å–
- **å®æ—¶çŠ¶æ€**: æ”¯æŒä»»åŠ¡è¿›åº¦å®æ—¶æŸ¥è¯¢
- **Cookieæ”¯æŒ**: å‰ç«¯å¯ä¼ å…¥è‡ªå®šä¹‰Cookieï¼Œæ— éœ€é¢„å…ˆé…ç½®
- **æ–‡ä»¶ä¸‹è½½**: å®Œæˆåæä¾›ç›´æ¥ä¸‹è½½é“¾æ¥
- **ç°ä»£API**: åŸºäº FastAPIï¼Œè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
- **æ ‘å½¢æ•°æ®**: ç›´æ¥æ„å»ºè¯„è®ºæ ‘å½¢ç»“æ„ï¼Œæ— éœ€ä¸­é—´æ–‡ä»¶

## ğŸ“¦ æŠ€æœ¯æ ˆ

- **FastAPI**: ç°ä»£ã€å¿«é€Ÿçš„Webæ¡†æ¶
- **Celery**: åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—
- **Redis**: æ¶ˆæ¯é˜Ÿåˆ—å’Œç»“æœåç«¯
- **Pydantic**: æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
- **bilibili-api**: Bç«™APIåº“

## ğŸ› ï¸ å®‰è£…éƒ¨ç½²

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.8+
- Redis Server

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. å¯åŠ¨æœåŠ¡

**Windows (æ¨èä½¿ç”¨PowerShellè„šæœ¬):**

```powershell
.\start.ps1
```

**æ‰‹åŠ¨å¯åŠ¨:**

```bash
# å¯åŠ¨ Redis
redis-server

# å¯åŠ¨ Celery Worker
celery -A celery_app worker -l info -P gevent -E

# å¯åŠ¨ FastAPI æœåŠ¡
uvicorn fastapi_app:app --host 0.0.0.0 --port 8000 --reload
```

## ğŸ“š API æ¥å£

### 1. æäº¤çˆ¬å–ä»»åŠ¡

- **URL**: `POST /api/crawl`
- **åŠŸèƒ½**: æäº¤ Bç«™è§†é¢‘çˆ¬å–ä»»åŠ¡
- **è¯·æ±‚ä½“**:
  ```json
  {
    "bv_id": "BV1AYKgzAE68",
    "cookie": {
      "sessdata": "your_sessdata_here",
      "bili_jct": "your_bili_jct_here",
      "buvid3": "your_buvid3_here",
      "dedeuserid": "your_dedeuserid_here",
      "ac_time_value": "your_ac_time_value_here"
    }
  }
  ```
- **å“åº”**:
  ```json
  {
    "task_id": "uuid-string",
    "message": "ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...",
    "status_url": "/api/status/uuid-string"
  }
  ```

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

- **URL**: `GET /api/status/{task_id}`
- **åŠŸèƒ½**: æŸ¥è¯¢æŒ‡å®šä»»åŠ¡çš„çŠ¶æ€å’Œç»“æœ
- **å“åº”**:
  ```json
  {
    "task_id": "uuid-string",
    "status": "SUCCESS|PENDING|STARTED|FAILURE",
    "result": {
      "file_path": "æ–‡ä»¶è·¯å¾„",
      "file_url": "ä¸‹è½½é“¾æ¥",
      "total_comments": 156,
      "independent_comments": 45
    },
    "progress": "è¿›åº¦ä¿¡æ¯",
    "download_url": "/api/download/uuid-string"
  }
  ```

### 3. ä¸‹è½½ç»“æœæ–‡ä»¶

- **URL**: `GET /api/download/{task_id}`
- **åŠŸèƒ½**: ä¸‹è½½çˆ¬å–ç»“æœJSONæ–‡ä»¶

### 4. å¥åº·æ£€æŸ¥

- **URL**: `GET /api/health`
- **åŠŸèƒ½**: æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒ [API_USAGE.md](API_USAGE.md) æ–‡ä»¶ã€‚

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
v2/
â”œâ”€â”€ main.py              # FastAPI åº”ç”¨ä¸»æ–‡ä»¶
â”œâ”€â”€ celery_app.py        # Celery é…ç½®å’Œä»»åŠ¡å®šä¹‰
â”œâ”€â”€ crawler.py           # çˆ¬è™«æ ¸å¿ƒé€»è¾‘ï¼ˆæ”¯æŒCookieä¼ å…¥ï¼‰
â”œâ”€â”€ models.py            # Pydantic æ•°æ®æ¨¡å‹
â”œâ”€â”€ requirements.txt     # ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ start.ps1           # Windows PowerShell å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.sh            # Linux/Mac Bash å¯åŠ¨è„šæœ¬
â”œâ”€â”€ README.md           # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ API_USAGE.md        # è¯¦ç»†ä½¿ç”¨æŒ‡å—
â””â”€â”€ output/             # è¾“å‡ºæ–‡ä»¶ç›®å½•
```

## ğŸ”§ é…ç½®è¯´æ˜

### Redis é…ç½®

é»˜è®¤è¿æ¥ `redis://localhost:6379/0`ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡ `REDIS_URL` ä¿®æ”¹ã€‚

### è¾“å‡ºç›®å½•

é»˜è®¤ä¿å­˜åˆ° `./output/` ç›®å½•ï¼Œæ–‡ä»¶åæ ¼å¼ï¼š`{è§†é¢‘æ ‡é¢˜}_comments.json`

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å¹¶å‘æ§åˆ¶**: Celery worker å¯é…ç½®å¹¶å‘æ•°
2. **é˜Ÿåˆ—åˆ†ç¦»**: å¯é…ç½®ä¸åŒç±»å‹ä»»åŠ¡ä½¿ç”¨ä¸åŒé˜Ÿåˆ—
3. **ç»“æœç¼“å­˜**: Redis ä½œä¸ºç»“æœç¼“å­˜ï¼Œæ”¯æŒæŒä¹…åŒ–
4. **æ–‡ä»¶ç®¡ç†**: å»ºè®®å®šæœŸæ¸…ç†outputç›®å½•

## ğŸ” ç›‘æ§ç®¡ç†

### æŸ¥çœ‹æ´»è·ƒä»»åŠ¡

```bash
curl "http://localhost:8000/api/tasks"
```

### å–æ¶ˆä»»åŠ¡

```bash
curl -X DELETE "http://localhost:8000/api/tasks/{task_id}"
```

### Celery ç›‘æ§

```bash
celery -A celery_app flower  # å¯åŠ¨ Flower ç›‘æ§ç•Œé¢
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **Cookieæœ‰æ•ˆæ€§**: Bç«™Cookieæœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦å‰ç«¯è´Ÿè´£Cookieçš„è·å–å’Œæ›´æ–°
2. **è¯·æ±‚é™åˆ¶**: é¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚ï¼Œå»ºè®®æ·»åŠ é€‚å½“å»¶æ—¶
3. **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨ç»“æœæ–‡ä»¶
4. **ç½‘ç»œç¨³å®š**: çˆ¬å–è¿‡ç¨‹ä¾èµ–ç½‘ç»œï¼Œå»ºè®®åœ¨ç¨³å®šç¯å¢ƒä¸‹è¿è¡Œ

## ğŸ”’ å®‰å…¨å»ºè®®

1. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿®æ”¹ CORS é…ç½®ï¼Œé™åˆ¶å…è®¸çš„åŸŸå
2. ä¸º Redis è®¾ç½®å¯†ç ä¿æŠ¤
3. è€ƒè™‘æ·»åŠ  API è®¿é—®é™åˆ¶å’Œè®¤è¯
4. å®šæœŸæ›´æ–°ä¾èµ–åŒ…ç‰ˆæœ¬

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
